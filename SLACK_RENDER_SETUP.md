# Slack Integration Setup for Render Deployment

## üö® Security First

**NEVER share credentials via:**
- Slack messages
- Screenshots
- Git commits
- Public channels

Always use:
- Render's encrypted environment variables
- Secret management systems

---

## Setup for Production (Render)

### Step 1: Regenerate Compromised Credentials

Your credentials were exposed in the screenshot. You MUST regenerate them:

1. Go to https://api.slack.com/apps
2. Select your "2nd Brain" app
3. Go to **"Basic Information"**
4. Under **"App Credentials"**:
   - Click **"Regenerate"** next to Client Secret
   - Click **"Regenerate"** next to Signing Secret
5. Copy the NEW credentials (don't screenshot or share them!)

### Step 2: Find Your Render Backend URL

1. Log in to https://dashboard.render.com
2. Find your `secondbrain-backend` service
3. Copy the URL (should be something like):
   ```
   https://secondbrain-backend-xxxx.onrender.com
   ```

### Step 3: Update Slack App Redirect URLs

1. Go to your Slack app ‚Üí **"OAuth & Permissions"**
2. Under **"Redirect URLs"**, add:
   ```
   https://secondbrain-backend-xxxx.onrender.com/api/integrations/slack/callback
   ```
   (Replace `xxxx` with your actual Render URL)

3. Keep the localhost URL for local development:
   ```
   http://localhost:5003/api/integrations/slack/callback
   ```

4. Click **"Save URLs"**

### Step 4: Configure Environment Variables in Render

1. Go to your `secondbrain-backend` service in Render
2. Click **"Environment"** tab
3. Add these environment variables:

   ```
   SLACK_CLIENT_ID=<your-new-client-id>
   SLACK_CLIENT_SECRET=<your-new-client-secret>
   SLACK_SIGNING_SECRET=<your-new-signing-secret>
   SLACK_REDIRECT_URI=https://secondbrain-backend-xxxx.onrender.com/api/integrations/slack/callback
   ```

4. Also add (if not already set):
   ```
   FRONTEND_URL=https://secondbrain-frontend-xxxx.onrender.com
   ```

5. Click **"Save Changes"**
6. Your service will automatically redeploy

### Step 5: Verify Backend Configuration

Once deployed, test the health endpoint:

```bash
curl https://secondbrain-backend-xxxx.onrender.com/api/health
```

Should return:
```json
{
  "status": "healthy",
  "timestamp": "..."
}
```

### Step 6: Connect Slack (Production)

1. Open your production frontend: `https://secondbrain-frontend-xxxx.onrender.com`
2. Log in to your account
3. Go to **Integrations** page
4. Click **"Connect"** on the Slack card
5. Authorize the app
6. You'll be redirected back to production

### Step 7: Sync Slack Messages

After successful connection:

1. In the Integrations page, find the Slack card (should show "Connected")
2. Click **"Sync Now"**
3. Wait for sync to complete (may take several minutes for large workspaces)

---

## Architecture: Local vs Production

### Local Development
```
Frontend:  http://localhost:3000
Backend:   http://localhost:5003
Callback:  http://localhost:5003/api/integrations/slack/callback
```

### Production (Render)
```
Frontend:  https://secondbrain-frontend-xxxx.onrender.com
Backend:   https://secondbrain-backend-xxxx.onrender.com
Callback:  https://secondbrain-backend-xxxx.onrender.com/api/integrations/slack/callback
```

---

## Complete Environment Variables Checklist for Render

### Backend Service (`secondbrain-backend`)

**Database (Auto-configured by Render):**
- ‚úÖ `DATABASE_TYPE=postgresql`
- ‚úÖ `POSTGRES_HOST` (from database)
- ‚úÖ `POSTGRES_PORT` (from database)
- ‚úÖ `POSTGRES_DB` (from database)
- ‚úÖ `POSTGRES_USER` (from database)
- ‚úÖ `POSTGRES_PASSWORD` (from database)

**Authentication:**
- ‚úÖ `JWT_SECRET_KEY` (auto-generated by Render)

**Azure OpenAI (Required):**
- ‚ö†Ô∏è `AZURE_OPENAI_ENDPOINT`
- ‚ö†Ô∏è `AZURE_OPENAI_API_KEY`
- ‚ö†Ô∏è `AZURE_API_VERSION=2024-12-01-preview`
- ‚ö†Ô∏è `AZURE_CHAT_DEPLOYMENT=gpt-4o` (or your deployment name)
- ‚ö†Ô∏è `AZURE_EMBEDDING_DEPLOYMENT=text-embedding-3-large`

**Pinecone (Required):**
- ‚ö†Ô∏è `PINECONE_API_KEY`
- ‚ö†Ô∏è `PINECONE_INDEX_NAME=secondbrain`
- ‚ö†Ô∏è `PINECONE_ENVIRONMENT` (e.g., us-east-1)

**Slack Integration (NEW):**
- ‚ö†Ô∏è `SLACK_CLIENT_ID`
- ‚ö†Ô∏è `SLACK_CLIENT_SECRET`
- ‚ö†Ô∏è `SLACK_SIGNING_SECRET`
- ‚ö†Ô∏è `SLACK_REDIRECT_URI=https://your-backend.onrender.com/api/integrations/slack/callback`

**Box Integration (Optional):**
- ‚ö†Ô∏è `BOX_CLIENT_ID`
- ‚ö†Ô∏è `BOX_CLIENT_SECRET`

**Gmail Integration (Optional):**
- ‚ö†Ô∏è `GOOGLE_CLIENT_ID`
- ‚ö†Ô∏è `GOOGLE_CLIENT_SECRET`

**Other:**
- ‚ö†Ô∏è `FRONTEND_URL=https://your-frontend.onrender.com`
- ‚ö†Ô∏è `LLAMA_CLOUD_API_KEY` (for document parsing)

### Frontend Service (`secondbrain-frontend`)

- ‚ö†Ô∏è `NEXT_PUBLIC_API_URL=https://your-backend.onrender.com`

---

## Troubleshooting Production Issues

### Issue: "Invalid redirect_uri"

**Cause:** Redirect URI mismatch between Slack app config and `SLACK_REDIRECT_URI` env var

**Solution:**
1. Check Slack app ‚Üí OAuth & Permissions ‚Üí Redirect URLs
2. Check Render env var `SLACK_REDIRECT_URI`
3. They MUST match exactly (including https vs http, trailing slashes, etc.)

### Issue: "Sync takes forever / times out"

**Cause:** Render free tier has limited resources, large Slack workspaces take time

**Solutions:**
1. Limit channels to sync (select specific important channels only)
2. Reduce `max_messages_per_channel` setting
3. Reduce `oldest_days` setting (don't sync entire history at once)
4. Consider upgrading to Render paid tier for better performance

### Issue: "Service crashes during sync"

**Cause:** Memory limits on Render free tier

**Solutions:**
1. Sync in smaller batches (fewer channels at a time)
2. Upgrade to Render paid tier (more memory)
3. Implement background job queue (future enhancement)

### Issue: "Cannot connect - CORS errors"

**Cause:** Frontend URL not whitelisted in backend CORS config

**Solution:**
Check `backend/app_v2.py` CORS configuration includes your production frontend URL:
```python
CORS(app, origins=[
    "http://localhost:3000",
    "http://localhost:3006",
    "https://secondbrain-frontend-xxxx.onrender.com"  # Add this
])
```

---

## Render Deployment Commands

### View Backend Logs
```bash
# In Render Dashboard:
secondbrain-backend ‚Üí Logs tab
```

Look for:
- `[Slack]` prefix for Slack-related logs
- Error messages during sync
- OAuth callback details

### Manual Redeploy
```bash
# In Render Dashboard:
secondbrain-backend ‚Üí Manual Deploy ‚Üí Deploy latest commit
```

### Check Database
```bash
# Connect to Render PostgreSQL (in Dashboard):
secondbrain-db ‚Üí Connect ‚Üí External Connection

# Then use psql:
psql -h <host> -U secondbrain -d secondbrain

# Check connectors:
SELECT id, connector_type, status, name, last_sync_at
FROM connectors
WHERE connector_type = 'slack';
```

---

## Security Best Practices

### ‚úÖ DO:
- Use Render's environment variables for secrets
- Regenerate credentials if exposed
- Use HTTPS for all production URLs
- Limit OAuth scopes to minimum needed
- Rotate credentials periodically

### ‚ùå DON'T:
- Commit credentials to git
- Share credentials via Slack/email/screenshots
- Use HTTP in production
- Give bot excessive permissions
- Store secrets in code

---

## Testing Production Setup

### 1. Test Backend Health
```bash
curl https://your-backend.onrender.com/api/health
```

### 2. Test Integrations List
```bash
curl -H "Authorization: Bearer <your-jwt-token>" \
  https://your-backend.onrender.com/api/integrations
```

### 3. Test OAuth Flow
1. Open frontend ‚Üí Integrations
2. Click "Connect" on Slack
3. Check browser DevTools ‚Üí Network tab
4. Should redirect to Slack, then back to frontend
5. Check for any 400/500 errors

### 4. Test Sync
```bash
curl -X POST \
  -H "Authorization: Bearer <your-jwt-token>" \
  https://your-backend.onrender.com/api/integrations/slack/sync
```

---

## Current Render Configuration

Based on `render.yaml`:

- **Backend:** Python 3.12, Gunicorn with 2 workers, 120s timeout
- **Frontend:** Node 20, Next.js production build
- **Database:** PostgreSQL free tier (Oregon region)
- **Region:** Oregon (all services)
- **Plan:** Free tier (both services)

### Free Tier Limitations:
- Services sleep after 15 min of inactivity (first request takes ~30s to wake up)
- 750 hours/month (roughly 1 service running 24/7)
- Limited CPU/memory
- Database: 1GB storage, 100 max connections

For production with active users, consider upgrading to paid tier.

---

## Next Steps After Slack Setup

1. **Test Local First:**
   - Set up locally with localhost URLs
   - Test OAuth flow, sync, search
   - Verify everything works

2. **Deploy to Production:**
   - Add regenerated credentials to Render
   - Update Slack app redirect URLs
   - Test production OAuth flow

3. **Configure Sync Settings:**
   - Select specific channels (don't sync all)
   - Set reasonable limits (1000 messages/channel)
   - Limit history (90-180 days instead of 365)

4. **Monitor Performance:**
   - Watch Render logs during sync
   - Check for memory/timeout issues
   - Adjust settings if needed

5. **Set Up Other Integrations:**
   - Gmail (if needed)
   - Box (if needed)
   - GitHub (if needed)

---

**Questions?** Check the main setup guide: `SLACK_INTEGRATION_SETUP.md`

**Remember:** Always regenerate credentials if they're exposed!
